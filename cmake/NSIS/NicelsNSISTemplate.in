; NicelsNSISTemplate.in
; Единый шаблон NSIS для nicels с аккуратной логикой PATH (без разветвлений на CPACK_NSIS_MODIFY_PATH).
; Дефолт: Add to PATH (All Users). Desktop icon по умолчанию выключен.

!include "MUI2.nsh"
!include "LogicLib.nsh"
!include "FileFunc.nsh"
!include "WinVer.nsh"asdasdadasdasd
; !include "MultiUser.nsh"

; !define MULTIUSER_EXECUTIONLEVEL Admin   ; Require admin rights
; !define MULTIUSER_INSTALLMODE_ALLUSERS   ; Default to all users
;!define MULTIUSER_INSTALLMODE_CURRENTUSER ; (optional fallback)

; ======= Переменные состояний (InstallOptions) =======
; Var DO_NOT_ADD_TO_PATH
; Var ADD_TO_PATH_ALL_USERS
; Var ADD_TO_PATH_CURRENT_USER
Var NLS_HAS_ADMIN
Var SV_ALLUSERS
Var DESKTOP_SHORTCUT

; ======= Иконка/надписи =======
!define MUI_ABORTWARNING
!define MUI_ICON "${CPACK_NSIS_INSTALLER_MUI_ICON}"

; ======= Страницы =======
!define MUI_CUSTOMFUNCTION_GUIINIT MyGuiInit

!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_COMPONENTS

; Страница с опциями (InstallOptions.ini) — обязательно до Directory, чтобы знать AllUsers/JustMe
!insertmacro MUI_INSTALLOPTIONS_EXTRACT "NSIS.InstallOptions.ini"
!insertmacro MUI_PAGE_DIRECTORY
!define MUI_PAGE_CUSTOMFUNCTION_SHOW ShowOptionsPage
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

!insertmacro MUI_LANGUAGE "English"

; ======= Имя инсталлятора и пути =======
Name "@CPACK_PACKAGE_NAME@"
OutFile "@CPACK_TOPLEVEL_DIRECTORY@/@CPACK_OUTPUT_FILE_NAME@"
InstallDir "$PROGRAMFILES\@CPACK_PACKAGE_INSTALL_DIRECTORY@"
ShowInstDetails hide
ShowUninstDetails hide
RequestExecutionLevel admin

; ======= Функции PATH =======
; Function AddToPath
;   Exch $0
;   Push $1
;   Push $2

;   SendMessage ${HWND_BROADCAST} ${WM_SETTINGCHANGE} 0 "STR:Environment" /TIMEOUT=5000

;   StrCpy $1 "$0"
;   StrCpy $2 ""

;   ${If} $ADD_TO_PATH_ALL_USERS == "1"
;     ReadRegStr $2 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
;   ${Else}
;     ReadRegStr $2 HKCU "Environment" "Path"
;   ${EndIf}

;   StrCpy $0 "$2"
;   ${If} $0 == ""
;     StrCpy $0 "$1"
;   ${Else}
;     ; Проверим, есть ли уже такой путь
;     Push "$0"
;     Push "$1"
;     Call StrStr
;     Pop $2
;     ${If} $2 == ""
;       StrCpy $0 "$0;$1"
;     ${EndIf}
;   ${EndIf}

;   ${If} $ADD_TO_PATH_ALL_USERS == "1"
;     WriteRegExpandStr HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path" "$0"
;     SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000
;   ${Else}
;     WriteRegExpandStr HKCU "Environment" "Path" "$0"
;     SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000
;   ${EndIf}

;   Pop $2
;   Pop $1
;   Exch $0
; FunctionEnd

Function un.RemoveFromPath
  Exch $0
  Push $1
  Push $2
  Push $3

  ; Определим, где мы добавляли
  StrCpy $3 "HKLM"
  ReadRegStr $2 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  ${IfThen} $2 == "" ${|} StrCpy $3 "HKCU" ${|}

  ${If} $3 == "HKLM"
    ReadRegStr $2 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  ${Else}
    ReadRegStr $2 HKCU "Environment" "Path"
  ${EndIf}

  StrCpy $1 "$2"
  ${If} $1 != ""
    ; Удаляем вхождение ";$0" и "$0;" и отдельный "$0"
    StrCpy $2 "$1"
    ; 1) ";$0"
    Push "$2"
    Push ";$0"
    Call StrStr
    Pop $3
    ${If} $3 != ""
      StrRep $2 "$2" ";$0" ""
    ${EndIf}
    ; 2) "$0;"
    Push "$2"
    Push "$0;"
    Call StrStr
    Pop $3
    ${If} $3 != ""
      StrRep $2 "$2" "$0;" ""
    ${EndIf}
    ; 3) "$0"
    Push "$2"
    Push "$0"
    Call StrStr
    Pop $3
    ${If} $3 != ""
      StrRep $2 "$2" "$0" ""
    ${EndIf}

    ${If} $3 != ""
      ${If} $3 == "HKLM"
        WriteRegExpandStr HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path" "$2"
      ${Else}
        WriteRegExpandStr HKCU "Environment" "Path" "$2"
      ${EndIf}
      SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000
    ${EndIf}
  ${EndIf}

  Pop $3
  Pop $2
  Pop $1
  Exch $0
FunctionEnd

; ======= Утилиты строк =======
; Поиск подстроки: на стеке: haystack, needle -> возврат в стек: "" если нет, иначе позиция/ссылка
Function StrStr
  Exch $R1 ; needle
  Exch
  Exch $R0 ; haystack
  Push $R2
  StrLen $R2 $R1
  StrCpy $R3 0
  loop:
    StrCpy $R4 $R0 "" $R3
    StrCmp $R4 "" done
    StrCpy $R4 $R4 $R2
    StrCmp $R4 $R1 found
    IntOp $R3 $R3 + 1
    Goto loop
  found:
    StrCpy $R0 $R3
    Goto end
  done:
    StrCpy $R0 ""
  end:
  Pop $R2
  Exch $R0
FunctionEnd

; Замена подстроки (простая)
!macro _StrRep Var Str Old New
  Push "${Str}"
  Push "${Old}"
  Push "${New}"
  Push "${Var}"
  Call StrRep
  Pop "${Var}"
!macroend
!define StrRep '!insertmacro _StrRep'

Function StrRep
  Exch $R1 ; Var name (по ссылке через Pop выше)
  Exch
  Exch $R3 ; New
  Exch
  Exch $R2 ; Old
  Exch
  Exch $R0 ; Str
  Push $R4
  Push $R5
  StrCpy $R4 ""
  loop:
    Push $R0
    Push $R2
    Call StrStr
    Pop $R5
    StrCmp $R5 "" done
    StrCpy $R6 $R0 $R5
    StrLen $R7 $R2
    IntOp $R8 $R5 + $R7
    StrCpy $R9 $R0 "" $R8
    StrCpy $R0 "$R9"
    StrCpy $R4 "$R4$R6$R3"
    Goto loop
  done:
    StrCpy $R4 "$R4$R0"
  StrCpy $R0 $R4
  Pop $R5
  Pop $R4
  Exch $R0
FunctionEnd

; ======= GUI Init: проверим права и выставим базовые значения =======
Function MyGuiInit
  UserInfo::GetAccountType
  Pop $0
  StrCmp $0 "Admin" +2
    StrCpy $NLS_HAS_ADMIN 0
    Goto +2
  StrCpy $NLS_HAS_ADMIN 1
FunctionEnd

; ======= Показ страницы опций: подставим дефолты/блокировки =======
Function ShowOptionsPage
  ; Выставляем визуальные состояния согласно дефолтам и правам
  !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 2" "State" "1"
  !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 3" "State" "0"

  ; PATH: по умолчанию all users = 1, do not add = 0, current user = 0
  ; !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 6" "State" "0"
  ; !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 7" "State" "1"
  ; !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 8" "State" "0"

  ; Если нет админ-прав — блокируем "для всех пользователей"
  ; StrCmp $NLS_HAS_ADMIN "1" +5
  ;   !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 7" "Flags" "DISABLED"
  ;   !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 7" "State" "0"
  ;   !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 8" "State" "1"
  ;   Goto +2
  ; !insertmacro MUI_INSTALLOPTIONS_WRITE "NSIS.InstallOptions.ini" "Field 7" "Flags" ""

  !insertmacro MUI_HEADER_TEXT "Options" "Choose additional options"
  !insertmacro MUI_INSTALLOPTIONS_DISPLAY "NSIS.InstallOptions.ini"

  ; Считываем выбранные значения
  !insertmacro MUI_INSTALLOPTIONS_READ $0 "NSIS.InstallOptions.ini" "Field 2" "State"
  StrCmp $0 "1" +2
    StrCpy $SV_ALLUSERS "JustMe"
    Goto +1
  StrCpy $SV_ALLUSERS "AllUsers"

  ; !insertmacro MUI_INSTALLOPTIONS_READ $DO_NOT_ADD_TO_PATH "NSIS.InstallOptions.ini" "Field 6" "State"
  ; !insertmacro MUI_INSTALLOPTIONS_READ $ADD_TO_PATH_ALL_USERS "NSIS.InstallOptions.ini" "Field 7" "State"
  ; !insertmacro MUI_INSTALLOPTIONS_READ $ADD_TO_PATH_CURRENT_USER "NSIS.InstallOptions.ini" "Field 8" "State"
  !insertmacro MUI_INSTALLOPTIONS_READ $DESKTOP_SHORTCUT "NSIS.InstallOptions.ini" "Field 9" "State"
FunctionEnd

; ======= .onInit: дефолты для тихой установки =======
Function .onInit
  ; По умолчанию — AllUsers + AddToPath(AllUsers) + No desktop shortcut
  StrCpy $SV_ALLUSERS "AllUsers"
  ; StrCpy $DO_NOT_ADD_TO_PATH 0
  ; StrCpy $ADD_TO_PATH_ALL_USERS 1
  ; StrCpy $ADD_TO_PATH_CURRENT_USER 0
  StrCpy $DESKTOP_SHORTCUT 0
FunctionEnd

; ======= Раздел установки =======
Section "Install"
  SetOutPath "$INSTDIR"

  ; Пример: основные файлы (CPack подставит)
  ; File "@CPACK_TEMPORARY_DIRECTORY@\_CPack_Packages\@CPACK_SYSTEM_NAME@\NSIS\@CPACK_PACKAGE_FILE_NAME@\bin\nicels.exe"
  ; Для простоты положим папку bin в $INSTDIR\bin
  CreateDirectory "$INSTDIR\bin"
  ; CPack сам добавит File команды на основе правил install()

  ; Создать ярлык (если выбран)
  StrCmp $DESKTOP_SHORTCUT "1" 0 +3
    CreateShortCut "$DESKTOP\@CPACK_PACKAGE_NAME@.lnk" "$INSTDIR\bin\nicels.exe"
    ; end-if

  ; PATH: добавляем, если не запретили
  ; StrCmp $DO_NOT_ADD_TO_PATH "1" +3 0
  ;   Push "$INSTDIR\bin"
  ;   Call AddToPath

  ; Записать деинсталлятор
  WriteUninstaller "$INSTDIR\Uninstall.exe"
SectionEnd

; ======= Раздел деинсталляции =======
Section "Uninstall"
  ; Удалить PATH
  Push "$INSTDIR\bin"
  Call un.RemoveFromPath

  ; Удалить файлы
  Delete "$DESKTOP\@CPACK_PACKAGE_NAME@.lnk"
  RMDir /r "$INSTDIR"
SectionEndsasasa
